<div class="worldinfo-viewer-popup">
    <h3>已觸發的世界書條目</h3>
    <hr>

    {{#if (or global characterPrimary characterAdditional chat other)}}
        {{#if global}}
        <div class="wi-category">
            <h4><span class="wi-emoji">🌐</span> 全域世界書</h4>
            {{#each global}}
            <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                    <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                    <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>

                    <!-- 【修正點】改為可折疊的 details 標籤 -->
                    {{#if keys}}
                    <details class="wi-details">
                        <summary class="wi-summary">主關鍵字</summary>
                        <div class="wi-details-content">{{keys}}</div>
                    </details>
                    {{/if}}
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary class="wi-summary">選填過濾器 & 邏輯</summary>
                        <div class="wi-details-content">
                            <p><b>過濾器：</b>{{secondaryKeys}}</p>
                            <p><b>邏輯：</b>{{selectiveLogicName}}</p>
                        </div>
                    </details>
                    {{/if}}
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        <!-- (為求簡潔，以下重複的區塊只展示一個，請將此結構套用到所有的分類中) -->

        {{#if characterPrimary}}
        <div class="wi-category">
            <h4><span class="wi-emoji">👤</span> 角色主要知識書</h4>
            {{#each characterPrimary}}
            <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                    <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                    <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>
                    {{#if keys}}
                    <details class="wi-details">
                        <summary class="wi-summary">主關鍵字</summary>
                        <div class="wi-details-content">{{keys}}</div>
                    </details>
                    {{/if}}
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary class="wi-summary">選填過濾器 & 邏輯</summary>
                        <div class="wi-details-content">
                            <p><b>過濾器：</b>{{secondaryKeys}}</p>
                            <p><b>邏輯：</b>{{selectiveLogicName}}</p>
                        </div>
                    </details>
                    {{/if}}
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        {{#if characterAdditional}}
        <div class="wi-category">
            <h4><span class="wi-emoji">📚</span> 角色額外知識書</h4>
            {{#each characterAdditional}}
            <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                    <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                    <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>
                    {{#if keys}}
                    <details class="wi-details">
                        <summary class="wi-summary">主關鍵字</summary>
                        <div class="wi-details-content">{{keys}}</div>
                    </details>
                    {{/if}}
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary class="wi-summary">選填過濾器 & 邏輯</summary>
                        <div class="wi-details-content">
                            <p><b>過濾器：</b>{{secondaryKeys}}</p>
                            <p><b>邏輯：</b>{{selectiveLogicName}}</p>
                        </div>
                    </details>
                    {{/if}}
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        {{#if chat}}
        <div class="wi-category">
            <h4><span class="wi-emoji">💬</span> 聊天知識書</h4>
            {{#each chat}}
            <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                    <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                    <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>
                    {{#if keys}}
                    <details class="wi-details">
                        <summary class="wi-summary">主關鍵字</summary>
                        <div class="wi-details-content">{{keys}}</div>
                    </details>
                    {{/if}}
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary class="wi-summary">選填過濾器 & 邏輯</summary>
                        <div class="wi-details-content">
                            <p><b>過濾器：</b>{{secondaryKeys}}</p>
                            <p><b>邏輯：</b>{{selectiveLogicName}}</p>
                        </div>
                    </details>
                    {{/if}}
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        {{#if other}}
        <div class="wi-category">
            <h4><span class="wi-emoji">📦</span> 其他</h4>
            {{#each other}}
             <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                     <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                     <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>
                    {{#if keys}}
                    <details class="wi-details">
                        <summary class="wi-summary">主關鍵字</summary>
                        <div class="wi-details-content">{{keys}}</div>
                    </details>
                    {{/if}}
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary class="wi-summary">選填過濾器 & 邏輯</summary>
                        <div class="wi-details-content">
                            <p><b>過濾器：</b>{{secondaryKeys}}</p>
                            <p><b>邏輯：</b>{{selectiveLogicName}}</p>
                        </div>
                    </details>
                    {{/if}}
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

    {{else}}
        <div class="wi-no-entries">
            <p>ℹ️ 沒有偵測到任何觸發的世界書條目。</p>
        </div>
    {{/if}}
</div>
