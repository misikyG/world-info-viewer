<div class="worldinfo-viewer-popup">
    <h3>已觸發的世界書條目</h3>
    <hr>

    {{#if (or global characterPrimary characterAdditional chat other)}}
        {{#if global}}
        <div class="wi-category">
            <h4><span class="wi-emoji">🌐</span> 全域世界書</h4>
            {{#each global}}
            <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                    <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                    
                    <!-- 【修改】使用 details 標籤來創建可折疊區塊 -->
                    {{#if keys}}
                    <details class="wi-details">
                        <summary>主關鍵字</summary>
                        <div class="wi-details-content">
                            <span>{{keys}}</span>
                        </div>
                    </details>
                    {{/if}}
                    
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary>選填過濾器</summary>
                        <div class="wi-details-content">
                            <span>{{secondaryKeys}}</span>
                            <div class="wi-info-item" style="margin-top: 4px;"><strong>邏輯：</strong><span>{{selectiveLogicName}}</span></div>
                        </div>
                    </details>
                    {{/if}}

                    <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        <!-- 以下對所有分類重複相同的修改 -->

        {{#if characterPrimary}}
        <div class="wi-category">
            <h4><span class="wi-emoji">👤</span> 角色主要知識書</h4>
            {{#each characterPrimary}}
            <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                    <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                    {{#if keys}}
                    <details class="wi-details">
                        <summary>主關鍵字</summary>
                        <div class="wi-details-content">
                            <span>{{keys}}</span>
                        </div>
                    </details>
                    {{/if}}
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary>選填過濾器</summary>
                        <div class="wi-details-content">
                            <span>{{secondaryKeys}}</span>
                            <div class="wi-info-item" style="margin-top: 4px;"><strong>邏輯：</strong><span>{{selectiveLogicName}}</span></div>
                        </div>
                    </details>
                    {{/if}}
                    <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        {{#if characterAdditional}}
        <div class="wi-category">
            <h4><span class="wi-emoji">📚</span> 角色額外知識書</h4>
            {{#each characterAdditional}}
            <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                    <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                    {{#if keys}}
                    <details class="wi-details">
                        <summary>主關鍵字</summary>
                        <div class="wi-details-content">
                            <span>{{keys}}</span>
                        </div>
                    </details>
                    {{/if}}
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary>選填過濾器</summary>
                        <div class="wi-details-content">
                            <span>{{secondaryKeys}}</span>
                            <div class="wi-info-item" style="margin-top: 4px;"><strong>邏輯：</strong><span>{{selectiveLogicName}}</span></div>
                        </div>
                    </details>
                    {{/if}}
                    <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        {{#if chat}}
        <div class="wi-category">
            <h4><span class="wi-emoji">💬</span> 聊天知識書</h4>
            {{#each chat}}
            <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                    <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                    {{#if keys}}
                    <details class="wi-details">
                        <summary>主關鍵字</summary>
                        <div class="wi-details-content">
                            <span>{{keys}}</span>
                        </div>
                    </details>
                    {{/if}}
                    {{#if secondaryKeys}}
                    <details class="wi-details">
                        <summary>選填過濾器</summary>
                        <div class="wi-details-content">
                            <span>{{secondaryKeys}}</span>
                            <div class="wi-info-item" style="margin-top: 4px;"><strong>邏輯：</strong><span>{{selectiveLogicName}}</span></div>
                        </div>
                    </details>
                    {{/if}}
                    <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}{{depthText}}</span></div>
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

        {{#if other}}
        <div class="wi-category">
            <h4><span class="wi-emoji">📦</span> 其他</h4>
            {{#each other}}
             <div class="wi-entry">
                <div class="wi-entry-header">
                    <span class="wi-emoji">{{emoji}}</span>
                    <span class="wi-title">{{worldName}} / {{entryName}}</span>
                </div>
                <div class="wi-entry-info">
                     <div class="wi-info-item"><strong>狀態：</strong><span>{{statusName}}</span></div>
                     {{#if keys}}
                     <details class="wi-details">
                         <summary>主關鍵字</summary>
                         <div class="wi-details-content">
                             <span>{{keys}}</span>
                         </div>
                     </details>
                     {{/if}}
                     {{#if secondaryKeys}}
                     <details class="wi-details">
                         <summary>選填過濾器</summary>
                         <div class="wi-details-content">
                             <span>{{secondaryKeys}}</span>
                             <div class="wi-info-item" style="margin-top: 4px;"><strong>邏輯：</strong><span>{{selectiveLogicName}}</span></div>
                         </div>
                     </details>
                     {{/if}}
                     <div class="wi-info-item"><strong>插入位置：</strong><span>{{position}}</span></div>
                </div>
                <div class="wi-entry-content">
                    <strong>內容：</strong>
                    <pre>{{content}}</pre>
                </div>
            </div>
            {{/each}}
        </div>
        {{/if}}

    {{else}}
        <div class="wi-no-entries">
            <p>ℹ️ 沒有偵測到任何觸發的世界書條目。</p>
        </div>
    {{/if}}
</div>
